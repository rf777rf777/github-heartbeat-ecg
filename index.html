<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>GitHub Heartbeat ECG</title>
    <link rel="stylesheet" href="assets/style.css">
</head>

<body>
    <h1 class="title">
        <!-- Pixel Heart (32x32 squares, green theme) -->
        <span class="pixel-heart32">
            <!-- Áî® 7x6 Ê†ºÂ≠ê‰æÜÊéíÁâà -->
            <!-- ÊØè‰∏ÄË°åÁõ¥Êé•Áî® span Ë°®Á§∫ÊúâÊñπÂ°äÁöÑ‰ΩçÁΩÆ -->
            <span style="--x:1;--y:0"></span>
            <span style="--x:2;--y:0"></span>
            <span style="--x:4;--y:0"></span>
            <span style="--x:5;--y:0"></span>

            <span style="--x:0;--y:1"></span>
            <span style="--x:1;--y:1"></span>
            <span style="--x:2;--y:1"></span>
            <span style="--x:3;--y:1"></span>
            <span style="--x:4;--y:1"></span>
            <span style="--x:5;--y:1"></span>
            <span style="--x:6;--y:1"></span>

            <span style="--x:0;--y:2"></span>
            <span style="--x:1;--y:2"></span>
            <span style="--x:2;--y:2"></span>
            <span style="--x:3;--y:2"></span>
            <span style="--x:4;--y:2"></span>
            <span style="--x:5;--y:2"></span>
            <span style="--x:6;--y:2"></span>

            <span style="--x:1;--y:3"></span>
            <span style="--x:2;--y:3"></span>
            <span style="--x:3;--y:3"></span>
            <span style="--x:4;--y:3"></span>
            <span style="--x:5;--y:3"></span>

            <span style="--x:2;--y:4"></span>
            <span style="--x:3;--y:4"></span>
            <span style="--x:4;--y:4"></span>

            <span style="--x:3;--y:5"></span>
        </span>



        GitHub Heartbeat ECG
    </h1>
    <p class="typing-text">Enter GitHub usernames and compare whose commit heartbeat is stronger!</p>

    <!-- Toolbar: ‰∏âÈ°ÜÊåâÈàï‰∏ÄÊéíÔºåÂêÑ‰Ωî 33% -->
    <div class="toolbar">
        <!-- Users dropdown -->
        <div class="dropdown toolbar-segment" id="usersDropdown">
            <button class="dropbtn"><span class="icon user"></span>Users (<span id="userCount">0</span>)</button>
            <div class="dropdown-content">
                <div id="userList"></div>

                <!-- Â∫ïÈÉ® 2:3 ÁöÑ +Add ËàáËº∏ÂÖ•Ê°Ü -->
                <div class="add-row">
                    <button class="add-btn" id="ddAddBtn">+ Add</button>
                    <input type="text" id="ddAddInput" class="add-input" placeholder="Enter Github Username">
                </div>
            </div>
        </div>

        <!-- Refresh -->
        <div class="toolbar-segment">
            <button class="dropbtn" id="toolbarRefresh"><span class="icon play"></span>Apply</button>
        </div>

        <!-- GIF -->
        <div class="toolbar-segment">
            <button class="dropbtn" id="toolbarGif"><span class="icon gif"></span>GIF</button>
        </div>
    </div>

    <div class="toolbar">
        <div class="toolbar-segment">
            <button class="dropbtn" id="toolbarSvg">‚¨á Export SVG</button>
        </div>
    </div>

    <div id="wrapper">
        <canvas id="ecgChart"></canvas>
    </div>
    <div id="diagnosis"></div>

    <!-- Modal / Message Box -->
    <div id="msgOverlay" class="modal-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="msgTitle" aria-describedby="msgText">
            <div class="modal-header">
                <div id="msgTitle" class="modal-title">Message</div>
                <button class="modal-close" id="msgCloseBtn" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <p id="msgText">...</p>
            </div>
            <div class="modal-footer">
                <button class="btn-ok" id="msgOkBtn">OK</button>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <script type="module">
        import { fetchContributions } from './src/api.js';
        import { getUsernames, removeUserByName } from './src/ui.js';
        import { initECG, setDatasets, exportECGAsGIF, exportECGAsSVG } from './src/chart.js';
        import { showMessage } from './src/msgBox.js';

        // ÂÖàÂàùÂßãÂåñ ECGÔºàÊúÉÊé•ÁÆ°ÂãïÁï´ËàáÈüøÊáâÂºèÔºâ
        initECG('ecgChart');

        // === Toolbar Ë°åÁÇ∫ ===
        const userCountEl = document.getElementById('userCount');
        const userListEl = document.getElementById('userList');
        const ddAddBtn = document.getElementById('ddAddBtn');
        const ddAddInput = document.getElementById('ddAddInput');

        // ‚Üì GIF ‚Üí Ëß∏ÁôºÂéüÊú¨ÁöÑ Export
        //document.getElementById('toolbarGif').addEventListener('click', async () => {
        //    const btn = document.getElementById('exportGif');
        //    if (btn) {
        //        btn.click();
        //    } else {
        //        // Ëã•È†ÅÈù¢Ê≤íÊúâ export ÊåâÈàïÔºåÂ∞±Áõ¥Êé•ÂëºÂè´ÂåØÂá∫
        //        const blob = await exportECGAsGIF({ seconds: 5, fps: 30, quality: 10 });
        //        const url = URL.createObjectURL(blob);
        //        const a = document.createElement('a');
        //        a.href = url; a.download = 'github-heartbeat.gif';
        //        document.body.appendChild(a); a.click(); a.remove();
        //        URL.revokeObjectURL(url);
        //    }
        //});

        // ‰∏ãÊãâÂ∫ïÈÉ®Ôºö+ Add ËàáËº∏ÂÖ•Ê°ÜÔºà2:3Ôºâ
        async function addUserFromDropdown() {
            const users = getUsernames();
            if (users.length >= 5) {
                await showMessage("Accept only 5 users!", { title: "Oops..." });
                return;
            }

            const val = (ddAddInput.value || '').trim();
            if (!val)
                return;

            if (users.includes(val)) {
                await showMessage(`User: ${val} exists!`, { title: "Oops..." });
                return;
            }

            const name_row_div = document.createElement('div');
            name_row_div.className = 'username-row'

            const username_div = document.createElement('div');
            username_div.className = 'user-item username';
            username_div.textContent = val || '(unnamed)';

            const remove_name_btn = document.createElement('button');
            //remove_name_btn.id = 
            remove_name_btn.className = 'remove-btn'
            remove_name_btn.innerHTML = '- Del';
            remove_name_btn.addEventListener('click', (e) => {
                e.target.parentElement.remove();
                updateUserCount();
            });

            name_row_div.appendChild(remove_name_btn);
            name_row_div.appendChild(username_div);

            userListEl.appendChild(name_row_div);
            ddAddInput.value = '';

            updateUserCount();
        }

        function updateUserCount() {
            const names = getUsernames();
            userCountEl.textContent = String(names.length);
        }

        ddAddBtn.addEventListener('click', addUserFromDropdown);
        ddAddInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                // Êää addUserFromDropdown Âª∂Âà∞‰∏ã‰∏ÄÂÄã tickÔºåÈÅøÈñãÂêå‰∏ÄÈ°Ü Enter
                setTimeout(() => addUserFromDropdown(), 0);
            }
        });

        // ÂèñÂæóË≥áÊñô‰∏¶Êõ¥Êñ∞ ECG
        const refreshBtn = document.getElementById('toolbarRefresh');
        refreshBtn.addEventListener('click', async () => {
            const users = getUsernames();
            //if (users.length === 0) {
            //    alert("Please enter at least one GitHub username");
            //    return;
            //}

            refreshBtn.disabled = true;

            const origHtml = refreshBtn.innerHTML;
            refreshBtn.textContent = 'Applying...';

            const colors = ["lime", "cyan", "yellow", "magenta", "orange"];
            const prepared = [];

            for (let i = 0; i < users.length; i++) {
                const user = users[i];
                const data = await fetchContributions(user); // { labels:[], data:[] }
                if (data.data.length <= 0) {
                    removeUserByName(user);
                    continue;
                }
                prepared.push({
                    username: user,
                    data: data.data,         // ÁúüÂØ¶ÊØèÊó• commit Êï∏Âàó
                    color: colors[i % colors.length]
                });
            }

            setDatasets(prepared);

            refreshBtn.innerHTML = origHtml;
            refreshBtn.disabled = false;

            ////Êõ¥Êñ∞Ë®∫Êñ∑ÂçÄÂ°ä
            //const diagnosis = document.getElementById('diagnosis');
            //diagnosis.innerHTML = prepared.map(d => {
            //    const avg = d.data.length ? (d.data.reduce((a, b) => a + b, 0) / d.data.length) : 0;
            //    const status = avg === 0 ? "üíÄ No activity"
            //        : avg < 1 ? "‚ö†Ô∏è Low"
            //            : avg < 3 ? "üíö Healthy"
            //                : "üî• Monster";
            //    return `<p>${d.username}: ${status} (avg ${avg.toFixed(2)})</p>`;
            //}).join('');
        });

        // Export GIF handler
        const exportBtn = document.getElementById('toolbarGif');
        exportBtn.addEventListener('click', async () => {
            try {
                exportBtn.disabled = true;

                const origHtml = exportBtn.innerHTML;
                exportBtn.textContent = 'Rendering GIF...';

                const blob = await exportECGAsGIF({ seconds: 15, fps: 20, quality: 5 });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'github-heartbeat.gif';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                exportBtn.innerHTML = origHtml;
                exportBtn.disabled = false;
            } catch (err) {
                console.error(err);
                await showMessage(`Export GIF failed: ${err.message}`, { title: "Oops..." });
                exportBtn.disabled = false;
                exportBtn.textContent = '‚¨á Export GIF';
            }
        });

        // Export SVG handler
        const exportSvgBtn = document.getElementById('toolbarSvg');
        exportSvgBtn?.addEventListener('click', async () => {
            try {
                exportSvgBtn.disabled = true;
                const orig = exportSvgBtn.innerHTML;
                exportSvgBtn.textContent = 'Rendering SVG...';

                // ËÆìÁ∑öÊÆµ‰πüÂãï„ÄÅÊñπÂêëÂêëÂ∑¶„ÄÅÈÄüÂ∫¶ 3 Áßí‰∏ÄÂúàÔºõÊéÉÊèèÊ¢ù‰πüÂãïÔºà2 ÁßíÔºâ
                const blob = await exportECGAsSVG({
                animateWave: true,
                waveDirection: 'left',
                wavePeriodSec: 3,
                animateScanBar: true,
                scanPeriodSec: 2
                });


                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'github-heartbeat.svg';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                exportSvgBtn.innerHTML = orig;
                exportSvgBtn.disabled = false;
            } catch (err) {
                console.error(err);
                await showMessage(`Export SVG failed: ${err.message}`, { title: "Oops..." });
                exportSvgBtn.disabled = false;
                exportSvgBtn.textContent = '‚¨á Export SVG';
            }
        });

    </script>
</body>

</html>