<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>GitHub Heartbeat ECG</title>
    <link rel="stylesheet" href="assets/style.css">
</head>

<body>
    <h1 class="title">
        <!-- Pixel Heart (32x32 squares, green theme) -->
        <span class="pixel-heart32">
            <!-- 用 7x6 格子來排版 -->
            <!-- 每一行直接用 span 表示有方塊的位置 -->
            <span style="--x:1;--y:0"></span>
            <span style="--x:2;--y:0"></span>
            <span style="--x:4;--y:0"></span>
            <span style="--x:5;--y:0"></span>

            <span style="--x:0;--y:1"></span>
            <span style="--x:1;--y:1"></span>
            <span style="--x:2;--y:1"></span>
            <span style="--x:3;--y:1"></span>
            <span style="--x:4;--y:1"></span>
            <span style="--x:5;--y:1"></span>
            <span style="--x:6;--y:1"></span>

            <span style="--x:0;--y:2"></span>
            <span style="--x:1;--y:2"></span>
            <span style="--x:2;--y:2"></span>
            <span style="--x:3;--y:2"></span>
            <span style="--x:4;--y:2"></span>
            <span style="--x:5;--y:2"></span>
            <span style="--x:6;--y:2"></span>

            <span style="--x:1;--y:3"></span>
            <span style="--x:2;--y:3"></span>
            <span style="--x:3;--y:3"></span>
            <span style="--x:4;--y:3"></span>
            <span style="--x:5;--y:3"></span>

            <span style="--x:2;--y:4"></span>
            <span style="--x:3;--y:4"></span>
            <span style="--x:4;--y:4"></span>

            <span style="--x:3;--y:5"></span>
        </span>



        GitHub Heartbeat ECG
    </h1>
    <p class="typing-text">Enter GitHub usernames and compare whose commit heartbeat is stronger!</p>

    <!-- Toolbar: 三顆按鈕一排，各佔 33% -->
    <div class="toolbar">
        <!-- Users dropdown -->
        <div class="dropdown toolbar-segment" id="usersDropdown">
            <button class="dropbtn"><span class="icon user"></span>Users (<span id="userCount">0</span>)</button>
            <div class="dropdown-content">
                <div id="userList"></div>

                <!-- 底部 2:3 的 +Add 與輸入框 -->
                <div class="add-row">
                    <button class="add-btn" id="ddAddBtn">+ Add</button>
                    <input type="text" id="ddAddInput" class="add-input" placeholder="Enter Github Username">
                </div>
            </div>
        </div>

        <!-- Refresh -->
        <div class="toolbar-segment">
            <button class="dropbtn" id="toolbarRefresh"><span class="icon play"></span>Apply</button>
        </div>

        <!-- GIF -->
        <div class="toolbar-segment">
            <button class="dropbtn" id="toolbarGif"><span class="icon gif"></span>GIF</button>
        </div>
    </div>

    <div id="wrapper">
        <canvas id="ecgChart"></canvas>
    </div>
    <div id="diagnosis"></div>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <script type="module">
        import { fetchContributions } from './src/api.js';
        import { getUsernames } from './src/ui.js';
        import { initECG, setDatasets, exportECGAsGIF } from './src/chart.js';

        // 先初始化 ECG（會接管動畫與響應式）
        initECG('ecgChart');

        // === Toolbar 行為 ===
        const userCountEl = document.getElementById('userCount');
        const userListEl = document.getElementById('userList');
        const ddAddBtn = document.getElementById('ddAddBtn');
        const ddAddInput = document.getElementById('ddAddInput');

        // ↓ GIF → 觸發原本的 Export
        //document.getElementById('toolbarGif').addEventListener('click', async () => {
        //    const btn = document.getElementById('exportGif');
        //    if (btn) {
        //        btn.click();
        //    } else {
        //        // 若頁面沒有 export 按鈕，就直接呼叫匯出
        //        const blob = await exportECGAsGIF({ seconds: 5, fps: 30, quality: 10 });
        //        const url = URL.createObjectURL(blob);
        //        const a = document.createElement('a');
        //        a.href = url; a.download = 'github-heartbeat.gif';
        //        document.body.appendChild(a); a.click(); a.remove();
        //        URL.revokeObjectURL(url);
        //    }
        //});

        // 下拉底部：+ Add 與輸入框（2:3）
        function addUserFromDropdown() {
            const users = getUsernames();
            if (users.length >= 5) {
                alert("Accept only 5 users!");
                return;
            }

            const val = (ddAddInput.value || '').trim();
            if (!val)
                return;

            if (users.includes(val)) {
                alert("User exists!");
                return;
            }

            const name_row_div = document.createElement('div');
            name_row_div.className = 'username-row'

            const username_div = document.createElement('div');
            username_div.className = 'user-item username';
            username_div.textContent = val || '(unnamed)';

            const remove_name_btn = document.createElement('button');
            //remove_name_btn.id = 
            remove_name_btn.className = 'remove-btn'
            remove_name_btn.innerHTML = '- Del';
            remove_name_btn.addEventListener('click', (e) => {
                e.target.parentElement.remove();
                updateUserCount();
            });

            name_row_div.appendChild(remove_name_btn);
            name_row_div.appendChild(username_div);

            userListEl.appendChild(name_row_div);
            ddAddInput.value = '';

            updateUserCount();
        }

        function updateUserCount() {
            const names = getUsernames();
            userCountEl.textContent = String(names.length);
        }

        ddAddBtn.addEventListener('click', addUserFromDropdown);
        ddAddInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addUserFromDropdown();
        });

        // 取得資料並更新 ECG
        const refreshBtn = document.getElementById('toolbarRefresh');
        refreshBtn.addEventListener('click', async () => {
            const users = getUsernames();
            //if (users.length === 0) {
            //    alert("Please enter at least one GitHub username");
            //    return;
            //}

            refreshBtn.disabled = true;

            const origHtml = refreshBtn.innerHTML;
            refreshBtn.textContent = 'Applying...';

            const colors = ["lime", "cyan", "yellow", "magenta", "orange"];
            const prepared = [];

            for (let i = 0; i < users.length; i++) {
                const user = users[i];
                const data = await fetchContributions(user); // { labels:[], data:[] }
                prepared.push({
                    username: user,
                    data: data.data,         // ← 真實每日 commit 數列
                    color: colors[i % colors.length]
                });
            }

            setDatasets(prepared);

            refreshBtn.innerHTML = origHtml;
            refreshBtn.disabled = false;

            ////更新診斷區塊
            //const diagnosis = document.getElementById('diagnosis');
            //diagnosis.innerHTML = prepared.map(d => {
            //    const avg = d.data.length ? (d.data.reduce((a, b) => a + b, 0) / d.data.length) : 0;
            //    const status = avg === 0 ? "💀 No activity"
            //        : avg < 1 ? "⚠️ Low"
            //            : avg < 3 ? "💚 Healthy"
            //                : "🔥 Monster";
            //    return `<p>${d.username}: ${status} (avg ${avg.toFixed(2)})</p>`;
            //}).join('');
        });

        // Export GIF handler
        const exportBtn = document.getElementById('toolbarGif');
        exportBtn.addEventListener('click', async () => {
            try {
                exportBtn.disabled = true;

                const origHtml = exportBtn.innerHTML;
                exportBtn.textContent = 'Rendering GIF...';

                const blob = await exportECGAsGIF({ seconds: 5, fps: 30, quality: 10 });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'github-heartbeat.gif';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                exportBtn.innerHTML = origHtml;
                exportBtn.disabled = false;
            } catch (err) {
                console.error(err);
                alert('Export GIF failed: ' + err.message);
                exportBtn.disabled = false;
                exportBtn.textContent = '⬇ Export GIF';
            }
        });
    </script>
</body>

</html>