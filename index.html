<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>GitHub Heartbeat ECG</title>
    <style>
        body {
            background: black;
            margin: 0;
            font-family: monospace;
            color: white;
            text-align: center;
        }

        #wrapper {
            width: 100%;
            height: 80vh;
            /* canvas takes 80% viewport height */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            width: 95%;
            height: 100%;
            display: block;
        }
    </style>
</head>

<body>
    <h2>💚 GitHub Heartbeat ECG</h2>
    <p>Enter GitHub usernames and compare whose commit heartbeat is stronger!</p>

    <div id="userInputs">
        <input type="text" class="username" placeholder="Enter GitHub username">
    </div>
    <button id="addUser">＋ Add User</button>
    <button id="fetchBtn">Generate ECG</button>
    <button id="exportGif">⬇ Export GIF</button>


    <div id="wrapper">
        <canvas id="ecgChart"></canvas>
    </div>
    <div id="diagnosis"></div>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <script type="module">
        import { fetchContributions } from './src/api.js';
        import { getUsernames } from './src/ui.js';
        import { initECG, setDatasets, exportECGAsGIF } from './src/chart.js';

        // 先初始化 ECG（會接管動畫與響應式）
        initECG('ecgChart');

        // UI：新增使用者輸入框
        document.getElementById('addUser').addEventListener('click', () => {
            const div = document.createElement('div');
            div.innerHTML = `<input type="text" class="username" placeholder="Enter GitHub username">`;
            document.getElementById('userInputs').appendChild(div);
        });

        // 取得資料並更新 ECG
        document.getElementById('fetchBtn').addEventListener('click', async () => {
            const users = getUsernames();
            if (users.length === 0) {
                alert("Please enter at least one GitHub username");
                return;
            }

            const colors = ["lime", "cyan", "yellow", "magenta", "orange"];
            const prepared = [];

            for (let i = 0; i < users.length; i++) {
                const user = users[i];
                const data = await fetchContributions(user); // { labels:[], data:[] }
                prepared.push({
                    username: user,
                    data: data.data,         // ← 真實每日 commit 數列
                    color: colors[i % colors.length]
                });
            }

            setDatasets(prepared);

            ////更新診斷區塊
            //const diagnosis = document.getElementById('diagnosis');
            //diagnosis.innerHTML = prepared.map(d => {
            //    const avg = d.data.length ? (d.data.reduce((a, b) => a + b, 0) / d.data.length) : 0;
            //    const status = avg === 0 ? "💀 No activity"
            //        : avg < 1 ? "⚠️ Low"
            //            : avg < 3 ? "💚 Healthy"
            //                : "🔥 Monster";
            //    return `<p>${d.username}: ${status} (avg ${avg.toFixed(2)})</p>`;
            //}).join('');
        });

        // Export GIF handler
        const exportBtn = document.getElementById('exportGif');
        exportBtn.addEventListener('click', async () => {
            try {
            exportBtn.disabled = true;
            const orig = exportBtn.textContent;
            exportBtn.textContent = 'Rendering GIF...';

            const blob = await exportECGAsGIF({ seconds: 5, fps: 30, quality: 10 });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'github-heartbeat.gif';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            exportBtn.textContent = orig;
            exportBtn.disabled = false;
            } catch (err) {
            console.error(err);
            alert('Export GIF failed: ' + err.message);
            exportBtn.disabled = false;
            exportBtn.textContent = '⬇ Export GIF';
            }
        });
    </script>
</body>

</html>