<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>GitHub Heartbeat ECG</title>
    <link rel="stylesheet" href="assets/style.css">
</head>

<body>
    <h2>ğŸ’š GitHub Heartbeat ECG</h2>
    <p>Enter GitHub usernames and compare whose commit heartbeat is stronger!</p>

    <div id="userInputs">
        <input type="text" class="username" placeholder="Enter GitHub username">
    </div>
    <button id="addUser">ï¼‹ Add User</button>
    <button id="fetchBtn">Generate ECG</button>
    <button id="exportGif">â¬‡ Export GIF</button>

    <!-- Toolbar: ä¸‰é¡†æŒ‰éˆ•ä¸€æ’ï¼Œå„ä½” 33% -->
    <div class="toolbar">
        <!-- Users dropdown -->
        <div class="dropdown toolbar-segment" id="usersDropdown">
            <button class="dropbtn"><span class="icon add"></span>Users (<span id="userCount">0</span>)</button>
            <div class="dropdown-content">
                <div id="userList"></div>

                <!-- åº•éƒ¨ 2:3 çš„ +Add èˆ‡è¼¸å…¥æ¡† -->
                <div class="add-row">
                    <button class="add-btn" id="ddAddBtn">+ Add</button>
                    <input type="text" id="ddAddInput" class="add-input" placeholder="[Name input]">
                </div>
            </div>
        </div>

        <!-- Refresh -->
        <div class="toolbar-segment" >
            <button class="dropbtn" id="toolbarRefresh"><span class="icon play"></span>Apply</button>
        </div>

        <!-- GIF -->
        <div class="toolbar-segment" >
            <button class="dropbtn" id="toolbarGif"><span class="icon gif"></span>GIF</button>
        </div>
    </div>

    <div id="wrapper">
        <canvas id="ecgChart"></canvas>
    </div>
    <div id="diagnosis"></div>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <script type="module">
        import { fetchContributions } from './src/api.js';
        import { getUsernames } from './src/ui.js';
        import { initECG, setDatasets, exportECGAsGIF } from './src/chart.js';

        // å…ˆåˆå§‹åŒ– ECGï¼ˆæœƒæ¥ç®¡å‹•ç•«èˆ‡éŸ¿æ‡‰å¼ï¼‰
        initECG('ecgChart');

        // === Toolbar è¡Œç‚º ===
        const userCountEl = document.getElementById('userCount');
        const userListEl = document.getElementById('userList');
        const ddAddBtn = document.getElementById('ddAddBtn');
        const ddAddInput = document.getElementById('ddAddInput');

        function updateUsersDropdown() {
            const names = getUsernames();
            userCountEl.textContent = String(names.length);
            userListEl.innerHTML = '';
            names.forEach(name => {
                const div = document.createElement('div');
                div.className = 'user-item';
                div.textContent = name || '(unnamed)';
                userListEl.appendChild(div);
            });
        }

        // Refresh â†’ è§¸ç™¼åŸæœ¬çš„ Generate ECG
        document.getElementById('toolbarRefresh').addEventListener('click', () => {
            const btn = document.getElementById('fetchBtn');
            if (btn) btn.click();
        });

        // â†“ GIF â†’ è§¸ç™¼åŸæœ¬çš„ Export
        document.getElementById('toolbarGif').addEventListener('click', async () => {
            const btn = document.getElementById('exportGif');
            if (btn) {
                btn.click();
            } else {
                // è‹¥é é¢æ²’æœ‰ export æŒ‰éˆ•ï¼Œå°±ç›´æ¥å‘¼å«åŒ¯å‡º
                const blob = await exportECGAsGIF({ seconds: 5, fps: 30, quality: 10 });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'github-heartbeat.gif';
                document.body.appendChild(a); a.click(); a.remove();
                URL.revokeObjectURL(url);
            }
        });

        // ä¸‹æ‹‰åº•éƒ¨ï¼š+ Add èˆ‡è¼¸å…¥æ¡†ï¼ˆ2:3ï¼‰
        function addUserFromDropdown() {
            const val = (ddAddInput.value || '').trim();
            const div = document.createElement('div');
            div.innerHTML = `<input type="text" class="username" placeholder="Enter GitHub username"${val ? ` value="${val}"` : ''}>`;
            document.getElementById('userInputs').appendChild(div);
            ddAddInput.value = '';
            updateUsersDropdown();
        }
        ddAddBtn.addEventListener('click', addUserFromDropdown);
        ddAddInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addUserFromDropdown();
        });

        // æ—¢æœ‰çš„ + Add User ä¹ŸåŒæ­¥æ›´æ–°æ¸…å–®ï¼ˆè‹¥å­˜åœ¨ï¼‰
        const addUserBtn = document.getElementById('addUser');
        if (addUserBtn) addUserBtn.addEventListener('click', () => setTimeout(updateUsersDropdown));

        // ä½¿ç”¨è€…è¼¸å…¥æ™‚å³æ™‚åˆ·æ–°æ¸…å–®
        document.getElementById('userInputs').addEventListener('input', (e) => {
            if (e.target && e.target.classList.contains('username')) updateUsersDropdown();
        });

        // åˆå§‹åŒæ­¥
        updateUsersDropdown();


        // UIï¼šæ–°å¢ä½¿ç”¨è€…è¼¸å…¥æ¡†
        document.getElementById('addUser').addEventListener('click', () => {
            const div = document.createElement('div');
            div.innerHTML = `<input type="text" class="username" placeholder="Enter GitHub username">`;
            document.getElementById('userInputs').appendChild(div);
        });

        // å–å¾—è³‡æ–™ä¸¦æ›´æ–° ECG
        document.getElementById('fetchBtn').addEventListener('click', async () => {
            const users = getUsernames();
            if (users.length === 0) {
                alert("Please enter at least one GitHub username");
                return;
            }

            const colors = ["lime", "cyan", "yellow", "magenta", "orange"];
            const prepared = [];

            for (let i = 0; i < users.length; i++) {
                const user = users[i];
                const data = await fetchContributions(user); // { labels:[], data:[] }
                prepared.push({
                    username: user,
                    data: data.data,         // â† çœŸå¯¦æ¯æ—¥ commit æ•¸åˆ—
                    color: colors[i % colors.length]
                });
            }

            setDatasets(prepared);

            ////æ›´æ–°è¨ºæ–·å€å¡Š
            //const diagnosis = document.getElementById('diagnosis');
            //diagnosis.innerHTML = prepared.map(d => {
            //    const avg = d.data.length ? (d.data.reduce((a, b) => a + b, 0) / d.data.length) : 0;
            //    const status = avg === 0 ? "ğŸ’€ No activity"
            //        : avg < 1 ? "âš ï¸ Low"
            //            : avg < 3 ? "ğŸ’š Healthy"
            //                : "ğŸ”¥ Monster";
            //    return `<p>${d.username}: ${status} (avg ${avg.toFixed(2)})</p>`;
            //}).join('');
        });

        // Export GIF handler
        const exportBtn = document.getElementById('exportGif');
        exportBtn.addEventListener('click', async () => {
            try {
                exportBtn.disabled = true;
                const orig = exportBtn.textContent;
                exportBtn.textContent = 'Rendering GIF...';

                const blob = await exportECGAsGIF({ seconds: 5, fps: 30, quality: 10 });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'github-heartbeat.gif';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                exportBtn.textContent = orig;
                exportBtn.disabled = false;
            } catch (err) {
                console.error(err);
                alert('Export GIF failed: ' + err.message);
                exportBtn.disabled = false;
                exportBtn.textContent = 'â¬‡ Export GIF';
            }
        });
    </script>
</body>

</html>